<html>
  <head>

    <meta name="viewport" content="width=device-width, user-scalable=no">

    <link rel="stylesheet" type="text/css" href="/css/main.css">
    
    <script src="/js/toxiclibs.js"></script>
    <script src="/js/processing-1.4.1.js"></script>
    <script src="/js/jquery-1.9.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>  
    <script>

      var socket = io.connect('http://localhost:5000/');
      //var socket = io.connect('http://ec2-54-200-79-16.us-west-2.compute.amazonaws.com:8080/');

      var id;
      var index; 
      var type;
      var userObjs = [];
      var userObj = {};

      var objectX;
      var objectY;
      var objectID; 

      var controllerID;
      var deathnote = [];
      var deathland;

      var displayText1 = "";
      var displayText2 = "";
      var displayText3 = "";

      var canvas;
      var context;
      var processingInstance;
      
      var init = function(){

        window.AudioContext = window.AudioContext||window.webkitAudioContext;
        
      };

      var playAudio = function(data){

        // The context is the base for the API.
        var audioContext = new AudioContext();

        gainNode = audioContext.createGain();
        gainNode.gain.value = .1;

        var audiotoplay = document.getElementById(data); 
        var audioSource = audioContext.createMediaElementSource(audiotoplay);

        audioSource.connect(audioContext.destination); // Connect 
        audiotoplay.play(); 
      };

      //common socket events -------------------------------------------
      socket.on('connect', function(){
        id = socket.socket.sessionid;
        console.log("Connected : " + socket.socket.sessionid);
      });

      socket.on('news', function (data) {
        console.log(data);
           
        type = data.uType;

        if(data.uType == 'display') {
            displayCanvas();
        }else if(data.uType == 'controller'){
            controllerID = data.uid;
            displayController(data);
        }else if(data.uType == 'user'){
            userInit();
        }

      });

      socket.on('playAudio', function (data){
        playAudio(data.music);

      });

      socket.on('disconnect', function (data){
        removeUser(data);
      });

      socket.on('message', function (data){

        //console.log("Recieved : "+ data);
          if (data == "You've got killed"){ 
             window.open('', '_self', '');
            window.close();
          }
      });

      socket.on('button', function (data) {

       for(var i = 0 ; i < userObjs.length; i++){

          if(userObjs[i].objectID == data.id){
            userObjs[i].sectionID = data.button;  
            //console.log("find the moving user!: " + userObjs[i].sectionID);
            move(data);
          } 
        } 
       if(data.uType == 'controller'){
          //console.log(data);
          moveController(data.button);
        }
      });

      socket.on('setKill', function (data){
        checkKillSection(data.sectionID);
      });

      socket.on('character', function (data){

        console.log("in socket/character " + data.id + " , " + data.character);
        if(data.character == "hand"){
          console.log("controller process is on!");
          var pjs = Processing.getInstanceById("thecanvas");   
          pjs.addParticle(data.id, data.character);    

        }else{
          //console.log("in socket.on('character') : " + data.id+", "+data.character);
          userObj = {

            objectID : data.id,
            objectIndex : userObjs.length,
            sectionID : 2,
            character : data.character
          };

          userObjs.push(userObj);
        
          var pjs = Processing.getInstanceById("thecanvas");     
          pjs.addParticle(userObj.objectID, userObj.character);
        }
      });

      //display socket part--------------------------------------------------------------------

      var displayCanvas = function(){

        canvas = document.getElementById("thecanvas");  
        context = canvas.getContext('2d');  
        canvas.style.display = "inline";
      };      

      //controller socket part-----------------------------------------------------------------

      var displayController = function(data){
        console.log("I'm the controller!");
        document.getElementById("controllerGUI").style.display = "inline"; 

        socket.emit('character', { id: id, character: "hand" }); 
           //var pjs = Processing.getInstanceById("thecanvas");   
        //pjs.addParticle(data.uid, "hand");

      };
      var moveController = function(data){
        var pjs = Processing.getInstanceById("thecanvas");
        pjs.moveHand(data);
      };

      var setKillSection = function (data) {
        socket.emit('setKill', { uType: "controller", sectionID: data });
      };
      var checkKillSection = function( data ){

        console.log("setKillSection : " +data +","+userObjs.length);
        for(var i = 0 ; i < userObjs.length; i++){
          //console.log("user's sectionID : "+userObjs[i].sectionID);
          if(userObjs[i].sectionID == data){
              deathnote.push(userObjs[i].objectID);  
            console.log("You will be killed: " + userObjs[i].sectionID);
            deathland = data;
            } 
          kill(deathland);
          deathnote = [];
        }   
      };
      var kill = function (sectionID){
          if(sectionID == 1){
               displayText1 = "BOOM!!"
          }else if(sectionID == 2){
               displayText2 = "BOOM!!" 
          }else if(sectionID == 3){
               displayText3 = "BOOM!!"
          }

          //playAudio("scream");

          for(var i = 0 ; i < deathnote.length; i++){
            removeUser(deathnote[i]);
            socket.emit('kill',deathnote[i]);
            console.log("deathnote : "+ deathnote[i]);

          }
          setInterval(function(){
                displayText1 = "bit.ly/chooseordie";
                displayText2 = "bit.ly/chooseordie";
                displayText3 = "bit.ly/chooseordie";
          }, 1000);
      };

      //user socket part-----------------------------------------------------------------------
      //obamaP, stevejobsP, ladygagaP, danielshiffmanP, nickiminajP, spongebobP, img6, img7, img8, img9, stevejobs0; 
  
      var nameList = ["obama","stevejobs","spongebob","ladygaga","danielshiffman","nickiminaj","marilynmonroe"];
      var isAssigned = false;

      var userInit = function(){
          document.getElementById("inputbox").style.display = "inline"; 
      };
      var nameCheck = function(){
          var userInput = $("input").val();
          userInput = userInput.toLowerCase();
          userInput.trim();
          userInput = removeSpaces(userInput);

          //console.log("changed userInput: "+userInput);
          
          for(var i = 0; i < nameList.length ; i ++ ){
            if(userInput == nameList[i]){
              isAssigned = true;
            }
          }
          if(isAssigned){
              nameCheck_success(userInput);
          }else{
              nameCheck_failure();
          }
      };

      function removeSpaces(string) {
        return string.split(' ').join('');
      }
      var nameCheck_failure = function(){
          //console.log("Fail!!");
          document.getElementById("command").innerHTML = "You put the wrong name!";
          document.getElementById("inputbox").style.display = "inline"; 
      };
      var nameCheck_success = function( data ){
          //console.log("Success!!");
          document.getElementById("command").innerHTML = "SUCCESS!";
          register(data);
      };
      var register = function( data ){
          socket.emit('character', { id: id, character: data }); 
          gameplay();
      };
      var gameplay = function(){
          document.getElementById("gui").style.display = "inline"; 
          document.getElementById("inputbox").style.display = "none";           
      };
      var gameover = function(){


      };
      var sendbtn = function(button) {
        socket.emit('button', { id: id, button: button });
      };
      var move = function (data){
        var choice = {
             objectID : data.id,
             sectionID : data.button,
        };
        var pjs = Processing.getInstanceById("thecanvas");          
        pjs.setSection(choice.objectID, choice.sectionID);
      };
      var removeUser = function(data){
        for(var i = 0 ; i < userObjs.length ; i++){
          if(userObjs[i].objectID == data){
              userObjs.splice(i,1);         
              var pjs = Processing.getInstanceById("thecanvas");          
              pjs.removeUsers(data);
          }
        }
      };

    </script>
  </head>
  <body onload = "init();">

    <audio loop id = "scream">
        <source src = "http://itp.nyu.edu/~jyp323/ju/wp-content/uploads/2013/10/180350__jorickhoofd__scream-noooh.wav" type = "audio/wav">
    </audio>
    <audio id = "bgm">
       <source src ="http://itp.nyu.edu/~jyp323/ju/wp-content/uploads/2013/10/Tetris-8-bit-Music-Tetris-Theme-Song.mp3" type = "audio/mp3">
    </audio>

    <div class = "container" id = "controllerGUI" style = "display:none">
        <div id = "debug"><h3>These buttons are for moving</h3></div>
        <button id="red" onclick= "sendbtn(1);"></button>
        <br/>
        <button id="yellow" onclick= "sendbtn(2);"></button>
        <br/>
        <button id="purple" onclick= "sendbtn(3);"></button>
        <div id = "debug"><h3>These buttons are for killing</h3></div>
        <button id="red" onclick= "setKillSection(1);"><h1>1</h1></button>
        <br/>
        <button id="yellow" onclick= "setKillSection(2);"><h1>2</h1></button>
        <br/>
        <button id="purple" onclick= "setKillSection(3);"><h1>3</h1></button>
    </div>
    <div class = "container" id = "inputbox" style = "display:none">
        <h3 id = "command">Put your ID on the name card!</h3>
        <input id="username" type="text" placeholder="ex)Obama" />
        <input type="submit" id="btnSubmit" class="btn" value="Submit" onclick = "nameCheck();"/>
    </div>

    <div class = "container" id = "gui" style = "display:none">        
        <div id = "debug"><h3>Choose a land of survival!</h3></div>
        <button id="red" onclick= "sendbtn(1);"></button>
        <br/>
        <button id="yellow" onclick= "sendbtn(2);"></button>
        <br/>
        <button id="purple" onclick= "sendbtn(3);"></button>
    </div>
    
    <canvas id = "thecanvas" style = "display:none" data-processing-sources="/pjs/display.pde"></canvas>
  
  </body>
</html>